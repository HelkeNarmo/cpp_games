name: Build Games

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        project: [type_tag]
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install SDL2 dependencies
      run: |
        brew update
        brew install sdl2 sdl2_image sdl2_ttf sdl2_mixer sdl2_net pkg-config

    - name: Build ${{ matrix.project }} for macOS
      run: |
        echo "ðŸ”¨ Building ${{ matrix.project }} for macOS..."
        ./build_cross_platform.sh ${{ matrix.project }}

    - name: Create ${{ matrix.project }} macOS release package
      run: |
        echo "ðŸ“¦ Creating release package for ${{ matrix.project }}..."
        ./create_release.sh ${{ matrix.project }}

    - name: Upload ${{ matrix.project }} macOS artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.project }}-macos
        path: ${{ matrix.project }}_macos_*.tar.gz
        if-no-files-found: error

  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        project: [type_tag]
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          mingw-w64-x86_64-gcc
          mingw-w64-x86_64-cmake
          mingw-w64-x86_64-make
          mingw-w64-x86_64-SDL2
          mingw-w64-x86_64-SDL2_image
          mingw-w64-x86_64-SDL2_ttf
          mingw-w64-x86_64-SDL2_mixer
          mingw-w64-x86_64-SDL2_net
          mingw-w64-x86_64-pkg-config

    - name: Build ${{ matrix.project }} for Windows
      shell: msys2 {0}
      run: |
        echo "ðŸ”¨ Building ${{ matrix.project }} for Windows..."
        echo "OSTYPE: $OSTYPE"
        echo "MSYSTEM: $MSYSTEM"
        ./build_cross_platform.sh ${{ matrix.project }}

    - name: Create ${{ matrix.project }} Windows release package
      shell: msys2 {0}
      run: |
        echo "ðŸ“¦ Creating release package for ${{ matrix.project }}..."
        ./create_release.sh ${{ matrix.project }}

    - name: Upload ${{ matrix.project }} Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.project }}-windows
        path: ${{ matrix.project }}_windows_*.tar.gz
        if-no-files-found: error

  build-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        project: [type_tag]
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install SDL2 dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libsdl2-dev \
          libsdl2-image-dev \
          libsdl2-ttf-dev \
          libsdl2-mixer-dev \
          libsdl2-net-dev \
          pkg-config \
          g++

    - name: Build ${{ matrix.project }} for Linux
      run: |
        echo "ðŸ”¨ Building ${{ matrix.project }} for Linux..."
        ./build_cross_platform.sh ${{ matrix.project }}

    - name: Create ${{ matrix.project }} Linux release package
      run: |
        echo "ðŸ“¦ Creating release package for ${{ matrix.project }}..."
        ./create_release.sh ${{ matrix.project }}

    - name: Upload ${{ matrix.project }} Linux artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.project }}-linux
        path: ${{ matrix.project }}_linux_*.tar.gz
        if-no-files-found: error

  release:
    needs: [build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && contains(github.ref, 'refs/tags/')
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          type_tag-macos/*.tar.gz
          type_tag-windows/*.tar.gz
          type_tag-linux/*.tar.gz
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
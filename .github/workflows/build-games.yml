name: Build Games

on:
  push:
    branches: [ main, master ]
    paths:
      - '**/*.cpp'
      - '**/*.h'
      - '**/*.hpp'
      - '**/img/**'
      - '**/font/**'
      - '**/aud/**'
      - '.github/workflows/build-games.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - '**/*.cpp'
      - '**/*.h'
      - '**/*.hpp'
      - '**/img/**'
      - '**/font/**'
      - '**/aud/**'
      - '.github/workflows/build-games.yml'
  workflow_dispatch:

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      build_type_tag: ${{ steps.filter.outputs.build_type_tag }}
      build_slime_survivor: ${{ steps.filter.outputs.build_slime_survivor }}
      build_tictactoe: ${{ steps.filter.outputs.build_tictactoe }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: Check for file changes
      id: filter
      run: |
        # Ê£ÄÊü•Âì™‰∫õÈ°πÁõÆÊúâÊñá‰ª∂ÂèòÊõ¥
        echo "Ê£ÄÊü•Êñá‰ª∂ÂèòÊõ¥..."

        # Ëé∑ÂèñÂèòÊõ¥ÁöÑÊñá‰ª∂ÂàóË°®
        if [[ "${{ github.event_name }}" == "push" ]]; then
          # Ê£ÄÊü•ÊòØÂê¶ÊòØÁ¨¨‰∏ÄÊ¨°Êé®ÈÄÅ
          COMMIT_COUNT=$(git rev-list --count HEAD)
          if [[ $COMMIT_COUNT -eq 1 ]]; then
            # Á¨¨‰∏ÄÊ¨°Êé®ÈÄÅÔºåÊûÑÂª∫ÊâÄÊúâÈ°πÁõÆ
            echo "üéØ Á¨¨‰∏ÄÊ¨°Êé®ÈÄÅÔºåÊûÑÂª∫ÊâÄÊúâÈ°πÁõÆ"
            CHANGED_FILES="type_tag/ slime_survivor/ tictactoe/"
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1)
          fi
        elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }})
        else
          # workflow_dispatch - Ê£ÄÊü•ÊâÄÊúâÈ°πÁõÆ
          CHANGED_FILES="type_tag/ slime_survivor/ tictactoe/"
        fi

        echo "ÂèòÊõ¥ÁöÑÊñá‰ª∂:"
        echo "$CHANGED_FILES"

        # Ê£ÄÊü•ÊØè‰∏™È°πÁõÆÊòØÂê¶ÊúâÂèòÊõ¥
        check_project() {
          local project=$1
          if echo "$CHANGED_FILES" | grep -q "^$project/"; then
            echo "true"
          else
            echo "false"
          fi
        }

        echo "build_type_tag=$(check_project type_tag)" >> $GITHUB_OUTPUT
        echo "build_slime_survivor=$(check_project slime_survivor)" >> $GITHUB_OUTPUT
        echo "build_tictactoe=$(check_project tictactoe)" >> $GITHUB_OUTPUT

        echo "Ê£ÄÊµãÁªìÊûú:"
        echo "  type_tag: $(check_project type_tag)"
        echo "  slime_survivor: $(check_project slime_survivor)"
        echo "  tictactoe: $(check_project tictactoe)"

  build-macos:
    needs: detect-changes
    runs-on: macos-latest
    strategy:
      matrix:
        project: [type_tag, slime_survivor, tictactoe]
    steps:
    - name: Check if ${{ matrix.project }} needs building
      id: check
      run: |
        # Map project names to output variables
        case "${{ matrix.project }}" in
          "type_tag")
            SHOULD_BUILD="${{ needs.detect-changes.outputs.build_type_tag }}"
            ;;
          "slime_survivor")
            SHOULD_BUILD="${{ needs.detect-changes.outputs.build_slime_survivor }}"
            ;;
          "tictactoe")
            SHOULD_BUILD="${{ needs.detect-changes.outputs.build_tictactoe }}"
            ;;
        esac

        if [[ "$SHOULD_BUILD" == "true" ]]; then
          echo "should_build=true" >> $GITHUB_OUTPUT
          echo "üéØ ${{ matrix.project }} ÊúâÂèòÊõ¥ÔºåÈúÄË¶ÅÊûÑÂª∫"
        else
          echo "should_build=false" >> $GITHUB_OUTPUT
          echo "‚è≠Ô∏è ${{ matrix.project }} Êó†ÂèòÊõ¥ÔºåË∑≥ËøáÊûÑÂª∫"
        fi
      shell: bash

    - name: Install SDL2 dependencies
      if: steps.check.outputs.should_build == 'true'
      run: |
        brew update
        brew install sdl2 sdl2_image sdl2_ttf sdl2_mixer sdl2_net pkg-config

    - name: Build ${{ matrix.project }} for macOS
      if: steps.check.outputs.should_build == 'true'
      run: |
        ./build_cross_platform.sh ${{ matrix.project }}

    - name: Create ${{ matrix.project }} macOS release package
      if: steps.check.outputs.should_build == 'true'
      run: |
        ./create_release.sh ${{ matrix.project }}

    - name: Upload ${{ matrix.project }} macOS artifact
      if: steps.check.outputs.should_build == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.project }}-macos
        path: ${{ matrix.project }}_macos_*.tar.gz

  build-windows:
    needs: detect-changes
    runs-on: windows-latest
    strategy:
      matrix:
        project: [type_tag, slime_survivor, tictactoe]
    steps:
    - name: Check if ${{ matrix.project }} needs building
      id: check
      run: |
        # Map project names to output variables
        case "${{ matrix.project }}" in
          "type_tag")
            SHOULD_BUILD="${{ needs.detect-changes.outputs.build_type_tag }}"
            ;;
          "slime_survivor")
            SHOULD_BUILD="${{ needs.detect-changes.outputs.build_slime_survivor }}"
            ;;
          "tictactoe")
            SHOULD_BUILD="${{ needs.detect-changes.outputs.build_tictactoe }}"
            ;;
        esac

        if [[ "$SHOULD_BUILD" == "true" ]]; then
          echo "should_build=true" >> $GITHUB_OUTPUT
          echo "üéØ ${{ matrix.project }} ÊúâÂèòÊõ¥ÔºåÈúÄË¶ÅÊûÑÂª∫"
        else
          echo "should_build=false" >> $GITHUB_OUTPUT
          echo "‚è≠Ô∏è ${{ matrix.project }} Êó†ÂèòÊõ¥ÔºåË∑≥ËøáÊûÑÂª∫"
        fi
      shell: bash

    - name: Checkout code
      if: steps.check.outputs.should_build == 'true'
      uses: actions/checkout@v4

    - name: Setup MSYS2
      if: steps.check.outputs.should_build == 'true'
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          mingw-w64-x86_64-gcc
          mingw-w64-x86_64-cmake
          mingw-w64-x86_64-make
          mingw-w64-x86_64-SDL2
          mingw-w64-x86_64-SDL2_image
          mingw-w64-x86_64-SDL2_ttf
          mingw-w64-x86_64-SDL2_mixer
          mingw-w64-x86_64-SDL2_net
          mingw-w64-x86_64-pkg-config

    - name: Build ${{ matrix.project }} for Windows
      if: steps.check.outputs.should_build == 'true'
      shell: msys2 {0}
      run: |
        ./build_cross_platform.sh ${{ matrix.project }}

    - name: Create ${{ matrix.project }} Windows release package
      if: steps.check.outputs.should_build == 'true'
      shell: msys2 {0}
      run: |
        ./create_release.sh ${{ matrix.project }}

    - name: Upload ${{ matrix.project }} Windows artifact
      if: steps.check.outputs.should_build == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.project }}-windows
        path: ${{ matrix.project }}_windows_*.zip

  build-linux:
    needs: detect-changes
    runs-on: ubuntu-latest
    strategy:
      matrix:
        project: [type_tag, slime_survivor, tictactoe]
    steps:
    - name: Check if ${{ matrix.project }} needs building
      id: check
      run: |
        # Map project names to output variables
        case "${{ matrix.project }}" in
          "type_tag")
            SHOULD_BUILD="${{ needs.detect-changes.outputs.build_type_tag }}"
            ;;
          "slime_survivor")
            SHOULD_BUILD="${{ needs.detect-changes.outputs.build_slime_survivor }}"
            ;;
          "tictactoe")
            SHOULD_BUILD="${{ needs.detect-changes.outputs.build_tictactoe }}"
            ;;
        esac

        if [[ "$SHOULD_BUILD" == "true" ]]; then
          echo "should_build=true" >> $GITHUB_OUTPUT
          echo "üéØ ${{ matrix.project }} ÊúâÂèòÊõ¥ÔºåÈúÄË¶ÅÊûÑÂª∫"
        else
          echo "should_build=false" >> $GITHUB_OUTPUT
          echo "‚è≠Ô∏è ${{ matrix.project }} Êó†ÂèòÊõ¥ÔºåË∑≥ËøáÊûÑÂª∫"
        fi
      shell: bash

    - name: Checkout code
      if: steps.check.outputs.should_build == 'true'
      uses: actions/checkout@v4

    - name: Install SDL2 dependencies
      if: steps.check.outputs.should_build == 'true'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libsdl2-dev \
          libsdl2-image-dev \
          libsdl2-ttf-dev \
          libsdl2-mixer-dev \
          libsdl2-net-dev \
          pkg-config \
          g++

    - name: Build ${{ matrix.project }} for Linux
      if: steps.check.outputs.should_build == 'true'
      run: |
        ./build_cross_platform.sh ${{ matrix.project }}

    - name: Create ${{ matrix.project }} Linux release package
      if: steps.check.outputs.should_build == 'true'
      run: |
        ./create_release.sh ${{ matrix.project }}

    - name: Upload ${{ matrix.project }} Linux artifact
      if: steps.check.outputs.should_build == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.project }}-linux
        path: ${{ matrix.project }}_linux_*.tar.gz

  release:
    needs: [detect-changes, build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && contains(github.ref, 'refs/tags/')
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          type_tag-macos/*.tar.gz
          type_tag-windows/*.zip
          type_tag-linux/*.tar.gz
          slime_survivor-macos/*.tar.gz
          slime_survivor-windows/*.zip
          slime_survivor-linux/*.tar.gz
          tictactoe-macos/*.tar.gz
          tictactoe-windows/*.zip
          tictactoe-linux/*.tar.gz
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}